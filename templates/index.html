<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIste Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { height: 100vh; overflow: hidden; }
        #sidebar { height: 100vh; overflow-y: auto; border-right: 1px solid #444; }
        #main { height: 100vh; display: flex; flex-direction: column; }
        
        #process-list {
            height: 50%;
            overflow-y: auto;
            border-bottom: 1px solid #444;
            background-color: #2b2b2b;
        }
        
        #console-container {
            height: 50%;
            display: flex;
            flex-direction: column;
        }
        
        #console { 
            flex-grow: 1; 
            background-color: #1e1e1e; 
            color: #0f0; 
            font-family: monospace; 
            padding: 1rem; 
            overflow-y: auto; 
            white-space: pre-wrap;
        }
        
        .process-row { cursor: pointer; }
        .process-row:hover { background-color: #3a3a3a; }
        .process-row.active { background-color: #0d6efd !important; color: white; }
        
        /* Sortable columns */
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background-color: #3a3a3a; }
        .sortable::after { content: ' ‚áÖ'; opacity: 0.4; font-size: 0.8em; }
        .sortable.asc::after { content: ' ‚ñ≤'; opacity: 1; }
        .sortable.desc::after { content: ' ‚ñº'; opacity: 1; }
        
        /* Filter controls */
        .filter-row { background-color: #343a40; }
        .filter-row input, .filter-row select {
            background-color: #495057 !important;
            border: none !important;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 bg-dark p-0" id="sidebar">
                <div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="text-white m-0">LIste Panel <span id="conn-status" class="text-success" title="Connesso">‚óè</span></h5>
                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#helpModal" title="Guida">‚ùì</button>
                </div>
                
                <div class="accordion accordion-flush" id="sidebarAccordion">
                    
                    <!-- Configurazione -->
                    <div class="accordion-item bg-dark border-bottom border-secondary">
                        <h2 class="accordion-header" id="headingConfig">
                            <button class="accordion-button bg-dark text-white shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig" aria-expanded="true" aria-controls="collapseConfig">
                                ‚öôÔ∏è Configurazione
                            </button>
                        </h2>
                        <div id="collapseConfig" class="accordion-collapse collapse show" aria-labelledby="headingConfig" data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body text-white pt-0">
                                <!-- Workflow Preset -->
                                <div class="mb-2">
                                    <label class="form-label text-info small mb-1">Workflow Preset</label>
                                    <select id="workflow_preset" class="form-select form-select-sm bg-secondary text-white border-0" onchange="updateWorkflowConfig()">
                                        <option value="" disabled selected>Caricamento...</option>
                                    </select>
                                    <div id="preset_details" class="text-muted mt-1" style="font-size: 0.7rem;"></div>
                                </div>

                                <!-- N Schools -->
                                <div class="mb-2">
                                    <label class="form-label small mb-1">N. Scuole</label>
                                    <input type="number" id="n_schools" class="form-control form-control-sm bg-secondary text-white border-0" value="5">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Download -->
                    <div class="accordion-item bg-dark border-bottom border-secondary">
                        <h2 class="accordion-header" id="headingDownload">
                            <button class="accordion-button collapsed bg-dark text-white shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDownload" aria-expanded="false" aria-controls="collapseDownload">
                                üì• Download
                            </button>
                        </h2>
                        <div id="collapseDownload" class="accordion-collapse collapse" aria-labelledby="headingDownload" data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body pt-0">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="runCmd('btn_sample')">Sample (5)</button>
                                    <button class="btn btn-outline-primary btn-sm text-start" onclick="runCmd('btn_strato')">Stratificato (N)</button>
                                    <button class="btn btn-outline-secondary btn-sm text-start" onclick="runCmd('btn_statali')">Tutte Statali</button>
                                    <button class="btn btn-outline-secondary btn-sm text-start" onclick="runCmd('btn_paritarie')">Tutte Paritarie</button>
                                    
                                    <hr class="border-secondary my-1">
                                    
                                    <!-- Region Selection -->
                                    <div class="input-group input-group-sm">
                                        <select id="region_select" class="form-select bg-secondary text-white border-secondary">
                                            <option value="ABRUZZO">Abruzzo</option>
                                            <option value="BASILICATA">Basilicata</option>
                                            <option value="CALABRIA">Calabria</option>
                                            <option value="CAMPANIA">Campania</option>
                                            <option value="EMILIA-ROMAGNA">Emilia-Romagna</option>
                                            <option value="FRIULI-VENEZIA GIULIA">Friuli-V.G.</option>
                                            <option value="LAZIO" selected>Lazio</option>
                                            <option value="LIGURIA">Liguria</option>
                                            <option value="LOMBARDIA">Lombardia</option>
                                            <option value="MARCHE">Marche</option>
                                            <option value="MOLISE">Molise</option>
                                            <option value="PIEMONTE">Piemonte</option>
                                            <option value="PUGLIA">Puglia</option>
                                            <option value="SARDEGNA">Sardegna</option>
                                            <option value="SICILIA">Sicilia</option>
                                            <option value="TOSCANA">Toscana</option>
                                            <option value="TRENTINO-ALTO ADIGE">Trentino-A.A.</option>
                                            <option value="UMBRIA">Umbria</option>
                                            <option value="VALLE D'AOSTA">Valle d'Aosta</option>
                                            <option value="VENETO">Veneto</option>
                                        </select>
                                        <button class="btn btn-outline-primary" onclick="runCmd('btn_regione')">Go</button>
                                    </div>
                                    
                                    <div class="btn-group btn-group-sm mt-1" role="group">
                                        <button type="button" class="btn btn-outline-info" onclick="runCmd('btn_metro')">Metro</button>
                                        <button type="button" class="btn btn-outline-info" onclick="runCmd('btn_non_metro')">Non-Metro</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analisi & Revisione -->
                    <div class="accordion-item bg-dark border-bottom border-secondary">
                        <h2 class="accordion-header" id="headingAnalysis">
                            <button class="accordion-button collapsed bg-dark text-white shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnalysis" aria-expanded="false" aria-controls="collapseAnalysis">
                                ü§ñ Analisi & Revisione
                            </button>
                        </h2>
                        <div id="collapseAnalysis" class="accordion-collapse collapse" aria-labelledby="headingAnalysis" data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body pt-0">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-sm text-start" onclick="runCmd('btn_run')">‚ñ∂Ô∏è Avvia Workflow</button>
                                    <button class="btn btn-outline-warning btn-sm text-start" onclick="runCmd('btn_backfill')">Backfill Metadati</button>
                                    <hr class="border-secondary my-1">
                                    
                                    <!-- OpenRouter Section -->
                                    <small class="text-warning text-uppercase fw-bold" style="font-size: 0.65rem;">Revisione OpenRouter</small>
                                    <div class="mb-1">
                                        <select id="model_select_openrouter" class="form-select form-select-sm bg-secondary text-white border-0">
                                            <option value="meta-llama/llama-3.3-70b-instruct:free" selected>Llama 3.3 70B (Free)</option>
                                            <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-outline-success btn-sm text-start" onclick="runCmd('btn_review')">Review Scores</button>
                                    <button class="btn btn-outline-secondary btn-sm text-start" onclick="runCmd('btn_review_slow')">Review Slow</button>

                                    <!-- Gemini Section -->
                                    <small class="text-success text-uppercase fw-bold mt-2" style="font-size: 0.65rem;">Revisione Gemini</small>
                                    <div class="mb-1">
                                        <select id="model_select_gemini" class="form-select form-select-sm bg-secondary text-white border-0">
                                            <option value="gemini-3-flash-preview" selected>Gemini 3 Flash Preview</option>
                                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                            <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-outline-success btn-sm text-start" onclick="runCmd('btn_review_gemini')">Review Gemini</button>
                                    <button class="btn btn-outline-success btn-sm text-start" onclick="runCmd('btn_review_scores_gemini')">Review Scores</button>

                                    <hr class="border-secondary my-1">
                                    <button class="btn btn-outline-danger btn-sm text-start" onclick="runCmd('btn_review_non_ptof')">Rimuovi Non-PTOF</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dati -->
                    <div class="accordion-item bg-dark border-bottom border-secondary">
                        <h2 class="accordion-header" id="headingData">
                            <button class="accordion-button collapsed bg-dark text-white shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapseData" aria-expanded="false" aria-controls="collapseData">
                                üìä Dati & Utility
                            </button>
                        </h2>
                        <div id="collapseData" class="accordion-collapse collapse" aria-labelledby="headingData" data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body pt-0">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-info btn-sm text-start" onclick="runCmd('btn_csv')">Rigenera CSV + Geo</button>
                                    <button class="btn btn-outline-info btn-sm text-start" onclick="runCmd('btn_dash')">Avvia Dashboard</button>
                                    <button class="btn btn-outline-danger btn-sm text-start" onclick="runCmd('btn_clean')">Pulisci Cache</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Main Area -->
            <div class="col-md-9 col-lg-10 p-0" id="main">
                <!-- Process List -->
                <div id="process-list" class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <ul class="nav nav-tabs" id="processTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-pane" type="button" role="tab">Processi Attivi</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="archive-tab" data-bs-toggle="tab" data-bs-target="#archive-pane" type="button" role="tab" onclick="loadArchive()">üì¶ Archivio</button>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="tab-content" id="processTabContent">
                        <!-- Active Processes Tab -->
                        <div class="tab-pane fade show active" id="active-pane" role="tabpanel">
                            <table class="table table-dark table-hover table-sm" id="active-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="command" data-table="active">Comando</th>
                                        <th class="sortable" data-sort="status" data-table="active">Stato</th>
                                        <th class="sortable" data-sort="timestamp" data-table="active">Avviato</th>
                                        <th>Azioni</th>
                                    </tr>
                                    <tr class="filter-row">
                                        <td><input type="text" class="form-control form-control-sm" id="filter-active-command" placeholder="üîç Filtra..." oninput="applyActiveFilters()"></td>
                                        <td>
                                            <select class="form-select form-select-sm" id="filter-active-status" onchange="applyActiveFilters()">
                                                <option value="">Tutti</option>
                                                <option value="running">Running</option>
                                                <option value="completed">Completed</option>
                                                <option value="failed">Failed</option>
                                            </select>
                                        </td>
                                        <td></td>
                                        <td><button class="btn btn-outline-secondary btn-sm py-0" onclick="clearActiveFilters()" title="Reset filtri">‚úñ</button></td>
                                    </tr>
                                </thead>
                                <tbody id="process-table-body">
                                    <!-- Rows injected via JS -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Archive Tab -->
                        <div class="tab-pane fade" id="archive-pane" role="tabpanel">
                            <table class="table table-dark table-hover table-sm" id="archive-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="command" data-table="archive">Comando</th>
                                        <th class="sortable" data-sort="status" data-table="archive">Stato</th>
                                        <th class="sortable" data-sort="archived_at" data-table="archive">Archiviato</th>
                                        <th>Azioni</th>
                                    </tr>
                                    <tr class="filter-row">
                                        <td><input type="text" class="form-control form-control-sm" id="filter-archive-command" placeholder="üîç Filtra..." oninput="applyArchiveFilters()"></td>
                                        <td>
                                            <select class="form-select form-select-sm" id="filter-archive-status" onchange="applyArchiveFilters()">
                                                <option value="">Tutti</option>
                                                <option value="completed">Completed</option>
                                                <option value="failed">Failed</option>
                                            </select>
                                        </td>
                                        <td></td>
                                        <td><button class="btn btn-outline-secondary btn-sm py-0" onclick="clearArchiveFilters()" title="Reset filtri">‚úñ</button></td>
                                    </tr>
                                </thead>
                                <tbody id="archive-table-body">
                                    <!-- Rows injected via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Console -->
                <div id="console-container">
                    <div class="bg-dark p-2 d-flex justify-content-between align-items-center border-top border-bottom border-secondary">
                        <span class="text-white fw-bold ms-2" id="console-title">üñ•Ô∏è Console Output</span>
                        <div>
                            <button class="btn btn-danger btn-sm me-2" id="btn_stop" onclick="stopCurrentCmd()" disabled>üõë STOP</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearConsole()">üßπ Clear</button>
                        </div>
                    </div>
                    <div id="console">Seleziona un processo per vedere i log...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">üìñ Guida LIste Panel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>‚öôÔ∏è Configurazione</h6>
                    <p class="small text-muted">
                        Seleziona il <b>Workflow Preset</b> per definire quali modelli AI utilizzare per l'analisi (Analyst, Planner, ecc.).<br>
                        Il <b>Modello Reviewer</b> viene usato specificamente per i comandi di revisione punteggi.
                    </p>

                    <h6 class="mt-3">üì• Download</h6>
                    <ul class="small text-muted">
                        <li><b>Sample (5):</b> Scarica 5 scuole casuali per test veloce.</li>
                        <li><b>Stratificato (N):</b> Scarica N scuole per ogni regione/ordine (bilanciato).</li>
                        <li><b>Tutte Statali/Paritarie:</b> Scarica l'intero dataset (Lento!).</li>
                        <li><b>Regione:</b> Scarica tutte le scuole della regione selezionata.</li>
                        <li><b>Metro/Non-Metro:</b> Filtra per aree metropolitane o periferiche.</li>
                    </ul>

                    <h6 class="mt-3">ü§ñ Analisi & Revisione</h6>
                    <ul class="small text-muted">
                        <li><b>Avvia Workflow:</b> Esegue l'analisi completa (Analyst -> Reviewer -> Refiner) sui PDF scaricati.</li>
                        <li><b>Backfill Metadati:</b> Cerca di recuperare dati mancanti (es. indirizzi) usando l'AI.</li>
                        <li><b>Review Scores:</b> Ricalcola i punteggi usando il modello selezionato nel menu "Modello Reviewer".</li>
                        <li><b>Review Gemini:</b> Usa specificamente Gemini per una revisione veloce ed economica.</li>
                    </ul>

                    <h6 class="mt-3">üìä Dati & Utility</h6>
                    <ul class="small text-muted">
                        <li><b>Rigenera CSV:</b> Ricostruisce il file CSV finale dai JSON analizzati.</li>
                        <li><b>Avvia Dashboard:</b> Lancia l'interfaccia Streamlit per esplorare i dati.</li>
                        <li><b>Pulisci Cache:</b> Rimuove file temporanei (utile se si blocca qualcosa).</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEventSource = null;
        let selectedProcessId = null;
        const consoleDiv = document.getElementById('console');
        const stopBtn = document.getElementById('btn_stop');
        const consoleTitle = document.getElementById('console-title');

        // Configuration Management
        let currentConfig = null;
        
        // Process data storage for filtering/sorting
        let allActiveProcesses = [];
        let allArchivedProcesses = [];
        
        // Sort state
        let activeSortColumn = 'timestamp';
        let activeSortDirection = 'desc';
        let archiveSortColumn = 'archived_at';
        let archiveSortDirection = 'desc';

        async function loadConfig() {
            try {
                const response = await fetch('/config');
                currentConfig = await response.json();
                renderConfigUI();
            } catch (e) {
                console.error("Failed to load config", e);
            }
        }

        function renderConfigUI() {
            if (!currentConfig) return;
            
            const select = document.getElementById('workflow_preset');
            if (!select) return;

            const details = document.getElementById('preset_details');
            
            select.innerHTML = '';
            
            // Populate presets
            for (const [key, value] of Object.entries(currentConfig.presets)) {
                const option = document.createElement('option');
                option.value = key;
                // Use preset name if available
                option.textContent = value.name || `Preset ${key}`;
                if (key == currentConfig.active_preset) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
            
            // Show details for active preset
            updatePresetDetails();
        }

        function updatePresetDetails() {
            const select = document.getElementById('workflow_preset');
            const details = document.getElementById('preset_details');
            const selectedKey = select.value;
            
            if (currentConfig && currentConfig.presets[selectedKey]) {
                const preset = currentConfig.presets[selectedKey];
                const models = preset.models || {};
                
                let summary = [];
                // Handle string models (simple) or object models (complex)
                for (const [role, modelDef] of Object.entries(models)) {
                    const modelName = typeof modelDef === 'object' ? modelDef.model : modelDef;
                    summary.push(`<b>${role}</b>: ${modelName}`);
                }
                
                if (preset.description) {
                    summary.unshift(`<i>${preset.description}</i><hr class="my-1">`);
                }
                
                details.innerHTML = summary.join('<br>');
            }
        }

        async function updateWorkflowConfig() {
            const select = document.getElementById('workflow_preset');
            const newPreset = select.value;
            
            // Optimistic update
            updatePresetDetails();
            
            try {
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active_preset: newPreset })
                });
                
                if (response.ok) {
                    const updatedConfig = await response.json();
                    currentConfig = updatedConfig; // Sync
                } else {
                    alert("Failed to save configuration");
                    loadConfig(); // Revert
                }
            } catch (e) {
                console.error("Save failed", e);
                loadConfig(); // Revert
            }
        }

        // Load processes on start
        window.onload = function() {
            loadConfig();
            loadModels();
            refreshProcessList(true); // true = first load
            setInterval(() => refreshProcessList(false), 2000); // Poll every 2s
            
            // Setup sortable columns
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const table = this.dataset.table;
                    const column = this.dataset.sort;
                    handleSort(table, column, this);
                });
            });
        };

        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                const models = await response.json();
                
                const openRouterSelect = document.getElementById('model_select_openrouter');
                const geminiSelect = document.getElementById('model_select_gemini');
                
                // Save current selections
                const currentOpenRouter = openRouterSelect.value;
                const currentGemini = geminiSelect.value;
                
                openRouterSelect.innerHTML = '';
                geminiSelect.innerHTML = '';
                
                // Helper to create option
                const createOption = (m) => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = `${m.name} ${m.is_free ? '(Free)' : ''}`;
                    return opt;
                };
                
                models.forEach(m => {
                    // Populate OpenRouter (All)
                    openRouterSelect.appendChild(createOption(m));
                    
                    // Populate Gemini (Only google/gemini*)
                    if (m.id.toLowerCase().includes('gemini')) {
                        geminiSelect.appendChild(createOption(m));
                    }
                });
                
                // Restore selection if exists, else default
                if (currentOpenRouter) openRouterSelect.value = currentOpenRouter;
                if (currentGemini) geminiSelect.value = currentGemini;
                
            } catch (e) {
                console.error("Failed to load models", e);
            }
        }

        async function refreshProcessList(isFirstLoad = false) {
            const statusDot = document.getElementById('conn-status');
            try {
                const response = await fetch('/processes');
                const processes = await response.json();
                allActiveProcesses = processes; // Store for filtering
                applyActiveFilters(); // Apply filters and render
                
                if (statusDot) {
                    statusDot.className = "text-success";
                    statusDot.title = "Connesso";
                }

                // Auto-select latest running process on first load
                if (isFirstLoad && !selectedProcessId && processes.length > 0) {
                    // Find first running process
                    const running = processes.find(p => p.status === 'running' || p.status === 'starting');
                    if (running) {
                        selectProcess(running.id, running.command);
                    } else if (processes.length > 0) {
                        // Or just the most recent one
                        selectProcess(processes[0].id, processes[0].command);
                    }
                }

            } catch (e) {
                console.error("Failed to fetch processes", e);
                if (statusDot) {
                    statusDot.className = "text-danger";
                    statusDot.title = "Disconnesso";
                }
            }
        }

        function renderProcessTable(processes) {
            const tbody = document.getElementById('process-table-body');
            tbody.innerHTML = '';
            
            processes.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'process-row';
                if (p.id === selectedProcessId) tr.classList.add('active');

                const date = new Date(p.timestamp * 1000).toLocaleTimeString();
                
                let statusBadge = '';
                if (p.status === 'running') statusBadge = '<span class="badge bg-primary">Running</span>';
                else if (p.status === 'completed') statusBadge = '<span class="badge bg-success">Completed</span>';
                else if (p.status === 'failed') statusBadge = '<span class="badge bg-danger">Failed</span>';
                else statusBadge = `<span class="badge bg-secondary">${p.status}</span>`;

                // Create cells manually
                const tdCmd = document.createElement('td');
                tdCmd.textContent = p.command;
                
                const tdStatus = document.createElement('td');
                tdStatus.innerHTML = statusBadge;
                
                const tdDate = document.createElement('td');
                tdDate.textContent = date;
                
                const tdActions = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-sm btn-outline-danger py-0';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.title = 'Elimina';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteProcess(p.id);
                });
                tdActions.appendChild(deleteBtn);

                tr.appendChild(tdCmd);
                tr.appendChild(tdStatus);
                tr.appendChild(tdDate);
                tr.appendChild(tdActions);
                
                tr.addEventListener('click', function() {
                    selectProcess(p.id, p.command);
                });
                
                tbody.appendChild(tr);
            });
        }

        function selectProcess(pid, command) {
            if (selectedProcessId === pid) return;
            
            selectedProcessId = pid;
            consoleTitle.textContent = `üñ•Ô∏è Console: ${command}`;
            consoleDiv.textContent = "Caricamento log...\n";
            
            // Update UI selection
            document.querySelectorAll('.process-row').forEach(row => row.classList.remove('active'));
            // Re-render to apply active class (lazy way)
            refreshProcessList();

            // Connect stream
            if (currentEventSource) currentEventSource.close();
            
            stopBtn.disabled = false; // Enable stop button tentatively
            
            currentEventSource = new EventSource(`/stream/${pid}`);
            
            currentEventSource.onmessage = function(e) {
                if (e.data === "[DONE]") {
                    currentEventSource.close();
                    stopBtn.disabled = true;
                    consoleDiv.textContent += "\n[Processo terminato]";
                } else {
                    consoleDiv.textContent += e.data + "\n";
                    consoleDiv.scrollTop = consoleDiv.scrollHeight;
                }
            };
            
            currentEventSource.onerror = function() {
                currentEventSource.close();
                stopBtn.disabled = true;
            };
        }

        async function runCmd(cmdId) {
            const nSchools = document.getElementById('n_schools').value;
            const regionSelect = document.getElementById('region_select');
            const region = regionSelect ? regionSelect.value : 'LAZIO';
            
            // Determine which model selector to use
            let model = '';
            if (cmdId.includes('gemini')) {
                model = document.getElementById('model_select_gemini').value;
            } else {
                model = document.getElementById('model_select_openrouter').value;
            }

            try {
                const response = await fetch('/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: cmdId,
                        params: { 
                            n_schools: nSchools, 
                            model: model,
                            region: region
                        }
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    refreshProcessList().then(() => {
                        selectProcess(data.id, data.command);
                    });
                } else {
                    alert(`Error: ${data.message}`);
                }
            } catch (e) {
                alert(`Network Error: ${e}`);
            }
        }

        async function stopCurrentCmd() {
            if (!selectedProcessId) return;
            try {
                await fetch(`/stop/${selectedProcessId}`, { method: 'POST' });
            } catch (e) {
                console.error(e);
            }
        }
        
        async function deleteProcess(pid) {
            if (!confirm("Archiviare questo processo? (Sar√† spostato nell'Archivio)")) return;
            try {
                const res = await fetch(`/delete/${pid}`, { method: 'POST' });
                const data = await res.json();
                if (data.status === 'error') {
                    alert(data.message);
                } else {
                    if (selectedProcessId === pid) {
                        selectedProcessId = null;
                        consoleDiv.textContent = "";
                        consoleTitle.textContent = "üñ•Ô∏è Console Output";
                        if (currentEventSource) currentEventSource.close();
                    }
                    refreshProcessList();
                }
            } catch (e) {
                console.error(e);
            }
        }
        
        async function loadArchive() {
            try {
                const response = await fetch('/archive');
                const archived = await response.json();
                allArchivedProcesses = archived; // Store for filtering
                applyArchiveFilters(); // Apply filters and render
            } catch (e) {
                console.error("Failed to load archive", e);
            }
        }
        
        function renderArchiveTable(archived) {
            const tbody = document.getElementById('archive-table-body');
            tbody.innerHTML = '';
            
            if (archived.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="4" class="text-muted text-center">Nessun processo archiviato</td>';
                tbody.appendChild(tr);
                return;
            }
            
            archived.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'process-row';

                const archivedDate = new Date(p.archived_at * 1000).toLocaleString();
                
                let statusBadge = '';
                if (p.status === 'completed') statusBadge = '<span class="badge bg-success">Completed</span>';
                else if (p.status === 'failed') statusBadge = '<span class="badge bg-danger">Failed</span>';
                else statusBadge = `<span class="badge bg-secondary">${p.status}</span>`;

                const tdCmd = document.createElement('td');
                tdCmd.textContent = p.command;
                
                const tdStatus = document.createElement('td');
                tdStatus.innerHTML = statusBadge;
                
                const tdDate = document.createElement('td');
                tdDate.textContent = archivedDate;
                
                const tdActions = document.createElement('td');
                
                // View logs button
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-sm btn-outline-info py-0 me-1';
                viewBtn.textContent = 'üìã';
                viewBtn.title = 'Vedi Log';
                viewBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    viewArchivedLogs(p.id, p.command);
                });
                tdActions.appendChild(viewBtn);
                
                // Restore button
                const restoreBtn = document.createElement('button');
                restoreBtn.className = 'btn btn-sm btn-outline-success py-0 me-1';
                restoreBtn.textContent = '‚Ü©Ô∏è';
                restoreBtn.title = 'Ripristina';
                restoreBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    restoreProcess(p.id);
                });
                tdActions.appendChild(restoreBtn);
                
                // Permanent delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-sm btn-outline-danger py-0';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.title = 'Elimina Definitivamente';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    permanentDeleteProcess(p.id);
                });
                tdActions.appendChild(deleteBtn);

                tr.appendChild(tdCmd);
                tr.appendChild(tdStatus);
                tr.appendChild(tdDate);
                tr.appendChild(tdActions);
                
                tbody.appendChild(tr);
            });
        }
        
        async function viewArchivedLogs(pid, command) {
            try {
                const response = await fetch(`/archive/${pid}`);
                const data = await response.json();
                
                consoleTitle.textContent = `üì¶ Archivio: ${command}`;
                consoleDiv.textContent = data.logs ? data.logs.join('\\n') : 'Nessun log disponibile';
                stopBtn.disabled = true;
            } catch (e) {
                console.error("Failed to load archived logs", e);
            }
        }
        
        async function restoreProcess(pid) {
            if (!confirm("Ripristinare questo processo nella lista attiva?")) return;
            try {
                const res = await fetch(`/restore/${pid}`, { method: 'POST' });
                if (res.ok) {
                    loadArchive();
                    refreshProcessList();
                }
            } catch (e) {
                console.error(e);
            }
        }
        
        async function permanentDeleteProcess(pid) {
            if (!confirm("ATTENZIONE: Eliminare DEFINITIVAMENTE questo processo e i suoi log?")) return;
            try {
                const res = await fetch(`/archive/${pid}`, { method: 'DELETE' });
                if (res.ok) {
                    loadArchive();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function clearConsole() {
            consoleDiv.textContent = '';
        }
        
        // ========== FILTERING FUNCTIONS ==========
        
        function applyActiveFilters() {
            const commandFilter = document.getElementById('filter-active-command')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('filter-active-status')?.value || '';
            
            let filtered = allActiveProcesses.filter(p => {
                const matchCommand = p.command.toLowerCase().includes(commandFilter);
                const matchStatus = !statusFilter || p.status === statusFilter;
                return matchCommand && matchStatus;
            });
            
            // Apply sorting
            filtered = sortData(filtered, activeSortColumn, activeSortDirection);
            
            renderProcessTable(filtered);
        }
        
        function applyArchiveFilters() {
            const commandFilter = document.getElementById('filter-archive-command')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('filter-archive-status')?.value || '';
            
            let filtered = allArchivedProcesses.filter(p => {
                const matchCommand = p.command.toLowerCase().includes(commandFilter);
                const matchStatus = !statusFilter || p.status === statusFilter;
                return matchCommand && matchStatus;
            });
            
            // Apply sorting
            filtered = sortData(filtered, archiveSortColumn, archiveSortDirection);
            
            renderArchiveTable(filtered);
        }
        
        function clearActiveFilters() {
            document.getElementById('filter-active-command').value = '';
            document.getElementById('filter-active-status').value = '';
            applyActiveFilters();
        }
        
        function clearArchiveFilters() {
            document.getElementById('filter-archive-command').value = '';
            document.getElementById('filter-archive-status').value = '';
            applyArchiveFilters();
        }
        
        // ========== SORTING FUNCTIONS ==========
        
        function handleSort(table, column, thElement) {
            // Update sort state
            if (table === 'active') {
                if (activeSortColumn === column) {
                    activeSortDirection = activeSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    activeSortColumn = column;
                    activeSortDirection = 'asc';
                }
            } else {
                if (archiveSortColumn === column) {
                    archiveSortDirection = archiveSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    archiveSortColumn = column;
                    archiveSortDirection = 'asc';
                }
            }
            
            // Update UI
            updateSortIndicators(table);
            
            // Re-apply filters (which also sorts)
            if (table === 'active') {
                applyActiveFilters();
            } else {
                applyArchiveFilters();
            }
        }
        
        function updateSortIndicators(table) {
            const tableEl = document.getElementById(table + '-table');
            if (!tableEl) return;
            
            const sortColumn = table === 'active' ? activeSortColumn : archiveSortColumn;
            const sortDirection = table === 'active' ? activeSortDirection : archiveSortDirection;
            
            tableEl.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.sort === sortColumn) {
                    th.classList.add(sortDirection);
                }
            });
        }
        
        function sortData(data, column, direction) {
            return [...data].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                
                // Handle string comparison
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                
                let result = 0;
                if (valA < valB) result = -1;
                else if (valA > valB) result = 1;
                
                return direction === 'asc' ? result : -result;
            });
        }
    </script>
</body>
</html>
